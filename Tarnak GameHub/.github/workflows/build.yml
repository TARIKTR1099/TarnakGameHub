name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-2022
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.28.x'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          C:\Program Files (x86)\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC
          build\_deps
        key: ${{ runner.os }}-deps-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-deps-

    - name: Configure CMake
      run: |
        cmake -B build -S . `
          -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DTARNAK_BUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 4

    - name: Run tests
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure

    - name: Package
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --target package

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: TarnakGameHub-Windows
        path: |
          build/bin/Release/*.exe
          build/bin/Release/*.dll
          assets/
          scripts/
          themes/
          translations/
        if-no-files-found: error

  build-installer:
    needs: build-windows
    runs-on: windows-2022
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: TarnakGameHub-Windows
        path: build/bin/Release

    - name: Setup Inno Setup
      run: |
        choco install innosetup

    - name: Build installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/setup.iss

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: TarnakGameHub-Installer
        path: installer/output/*.exe
        if-no-files-found: error

  release:
    needs: build-installer
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4

    - name: Download installer
      uses: actions/download-artifact@v4
      with:
        name: TarnakGameHub-Installer
        path: ./installer

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./installer/*.exe
        body: |
          ## Tarnak Game Hub ${{ github.ref_name }}
          
          ### Installation
          Download and run `TarnakGameHub-Setup-${{ github.ref_name }}.exe`
          
          ### What's New
          See [CHANGELOG.md](CHANGELOG.md) for details.
          
          ### System Requirements
          - Windows 10/11 (64-bit)
          - Visual C++ Redistributables (included in installer)
          
          ### Links
          - Documentation: https://github.com/${{ github.repository }}/blob/main/README.md
          - Issues: https://github.com/${{ github.repository }}/issues
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  code-quality:
    runs-on: windows-2022
    
    steps:
    - uses: actions/checkout@v4

    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: cpp

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Lint Lua scripts
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.3
        for f in scripts/*.lua; do
          lua -e "dofile('$f')" 2>&1 || echo "Syntax error in $f"
        done

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Check documentation
      run: |
        test -f README.md || exit 1
        test -f CHANGELOG.md || exit 1
        test -f LICENSE || exit 1
        test -f CONTRIBUTING.md || exit 1
        echo "All required documentation files present"
